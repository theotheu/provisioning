# Run this _as a regular user_  with
#  sudo -H ansible-playbook packages.yml  --connection=local
#
# Run a single role by executing
#  sudo -H ansible-playbook packages.yml  --connection=local --tags "<role>"
# @see https://github.com/geerlingguy/ansible-role-mysql/issues/212

- hosts: 127.0.0.1
  connection: local
  become: true
  become_user: root
  roles:
    - {role: 'java', tags: 'java'}
    - {role: 'mysql', tags: 'mysql'}
    - {role: 'sonar', tags: 'sonar'}
    - {role: 'jenkins', tags: 'jenkins'}
    - {role: 'nginx', tags: 'nginx'}    
#    - common
#    - users


---
- hosts: all
  roles:
    - role: nginx
      nginx_error_log_level: info
      nginx_http_params:
        - sendfile on
        - access_log /var/log/nginx/access.log
      nginx_sites:
        foo:
           - listen 8080
           - server_name localhost
           - root /tmp/site1
           - location / { try_files $uri $uri/ /index.html; }
           - location /images/ { try_files $uri $uri/ /index.html; }
        bar:
           - listen 9090
           - server_name ansible
           - root /tmp/site2
           - if ( $host = example.com ) { rewrite ^(.*)$ http://www.example.com$1 permanent; }
           - location / {
             try_files $uri $uri/ /index.html;
             auth_basic            "Restricted";
             auth_basic_user_file  auth_basic/demo;
           }
           - location /images/ { try_files $uri $uri/ /index.html; }
      nginx_configs:
        proxy:
            - proxy_set_header X-Real-IP  $remote_addr
            - proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for
        upstream:
            # Results in:
            # upstream foo_backend {
            #   server 127.0.0.1:8080 weight=10;
            # }
            - upstream foo_backend { server 127.0.0.1:8080 weight=10; }
      nginx_auth_basic_files:
        demo:
           - foo:$apr1$mEJqnFmy$zioG2q1iDWvRxbHuNepIh0 # foo:demo , generated by : htpasswd -nb foo demo
           - bar:$apr1$H2GihkSo$PwBeV8cVWFFQlnAJtvVCQ. # bar:demo , generated by : htpasswd -nb bar demo